<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stoic Journey ‚Äî MVP</title>
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root{
      --bg:#0b1020;/*slate-950*/
      --panel:#0f172a;/*slate-900*/
      --muted:#94a3b8;/*slate-400*/
      --text:#e6edf6;/*slate-100*/
      --brand:#22c55e;/*green-500*/
      --accent:#38bdf8;/*sky-400*/
      --danger:#ef4444;/*red-500*/
      --card:#111827;/*gray-900*/
      --ring: 0 0 0 2px var(--accent) inset;
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 80% -20%,rgba(56,189,248,.10),transparent 60%),
                   radial-gradient(800px 400px at -10% 20%,rgba(34,197,94,.08),transparent 60%),var(--bg);
         color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    header.top{position:sticky;top:0;z-index:20;background:linear-gradient(var(--panel),rgba(15,23,42,.7));backdrop-filter: blur(8px);border-bottom:1px solid rgba(148,163,184,.18)}
    header.top .row{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 20px}
    .app-title{font-weight:700;letter-spacing:.3px}
    .path-pill{display:flex;gap:6px;align-items:center;background:rgba(34,197,94,.15);border:1px solid rgba(34,197,94,.35);color:#bbf7d0;padding:6px 10px;border-radius:999px;font-size:12px}
    nav.tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{appearance:none;border:1px solid rgba(148,163,184,.2);background:rgba(17,24,39,.6);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .tab[aria-selected="true"]{border-color:rgba(56,189,248,.6);outline:var(--ring);color:#e0f2fe}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:linear-gradient(180deg, rgba(17,24,39,.9), rgba(17,24,39,.7));border:1px solid rgba(148,163,184,.18);border-radius:var(--radius);padding:16px}
    .card h2{margin:0 0 8px;font-size:18px}
    .muted{color:var(--muted)}
    textarea,input,select,button{font:inherit}
    textarea,input[type="text"],input[type="date"],input[type="number"],select{width:100%;background:#0b1220;border:1px solid rgba(148,163,184,.25);color:var(--text);padding:10px 12px;border-radius:12px}
    textarea:focus,input:focus,select:focus{outline:var(--ring)}
    button.primary{background:linear-gradient(180deg,#22c55e,#16a34a);color:white;border:none;border-radius:12px;padding:10px 14px;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(148,163,184,.25);color:var(--text);border-radius:12px;padding:10px 14px;cursor:pointer}
    .row{display:flex;gap:10px;align-items:center}
    .spacer{flex:1}
    .hidden{display:none !important}
    .quote{font-size:18px;line-height:1.45}
    .byline{font-size:13px;color:#a5b4fc}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(56,189,248,.12);border:1px solid rgba(56,189,248,.35);color:#e0f2fe;font-size:12px}
    .kpi{font-size:28px;font-weight:700}
    .kpi small{font-size:12px;color:var(--muted);font-weight:500}
    .range{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
    .range input{accent-color:#22c55e}
    .list{display:grid;gap:10px}
    .concern{display:flex;gap:8px;align-items:center;padding:8px 10px;background:#0b1220;border:1px dashed rgba(148,163,184,.25);border-radius:10px}
    details summary{cursor:pointer}
    .footer-note{font-size:12px;color:var(--muted)}
    .badge{font-size:11px;color:#cbd5e1;padding:2px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.3)}
    .progress-bar{height:10px;background:#0b1220;border-radius:999px;overflow:hidden;border:1px solid rgba(148,163,184,.2)}
    .progress-bar>div{height:100%;background:linear-gradient(90deg,#38bdf8,#22c55e)}
    .section-title{margin:0 0 6px}
    @media (max-width:840px){.grid{grid-template-columns:1fr}.row.wrap{flex-wrap:wrap}}
  </style>
</head>
<body>
  <header class="top">
    <div class="row">
      <div class="row" style="gap:12px">
        <div class="app-title">üß≠ Stoic Journey</div>
        <div id="pathPill" class="path-pill" role="status" aria-live="polite" title="Your chosen path"></div>
      </div>
      <nav class="tabs" role="tablist" aria-label="Primary">
        <button class="tab" role="tab" data-tab="today" aria-selected="true">Today</button>
        <button class="tab" role="tab" data-tab="exercises" aria-selected="false">Exercises</button>
        <button class="tab" role="tab" data-tab="progress" aria-selected="false">Progress</button>
        <button class="tab" role="tab" data-tab="library" aria-selected="false">Library</button>
        <button class="tab" role="tab" data-tab="settings" aria-selected="false">Settings</button>
      </nav>
    </div>
  </header>

  <main class="wrap">

    <!-- Onboarding Path (modal style block shown if no path yet) -->
    <section id="onboarding" class="card" aria-labelledby="onbTitle" style="display:none;margin-bottom:16px">
      <h2 id="onbTitle">Choose your path</h2>
      <p class="muted">Why are you here? Pick a north star to personalize your journey. You can change this anytime in Settings.</p>
      <div class="row" style="flex-wrap:wrap;gap:10px;margin:8px 0 12px">
        <button class="ghost" data-path="Calm">ü´ß Calm</button>
        <button class="ghost" data-path="Resilience">üõ°Ô∏è Resilience</button>
        <button class="ghost" data-path="Wisdom">üß† Wisdom</button>
        <button class="ghost" data-path="Leadership">üåø Leadership</button>
        <button class="ghost" data-path="Discipline">‚è±Ô∏è Discipline</button>
      </div>
      <div class="footer-note">Tip: this only guides recommendations; Stoicism trains all four virtues.</div>
    </section>

    <!-- TODAY TAB -->
    <section id="tab-today" role="tabpanel" aria-labelledby="tab-today-btn">
      <div class="grid">
        <article class="card" style="grid-column:span 7">
          <h2>Meditation of the Day</h2>
          <div id="quote" class="quote">‚Ä¶</div>
          <div id="byline" class="byline muted" style="margin-top:6px"></div>
          <div class="row" style="margin-top:12px;gap:8px">
            <span class="pill" id="lessonTag">Virtue: ‚Äî</span>
            <span class="pill" id="controlTag">Control: ‚Äî</span>
            <div class="spacer"></div>
            <button id="btnViewLesson" class="ghost">Open lesson</button>
          </div>
        </article>

        <article class="card" style="grid-column:span 5">
          <h2>Streak</h2>
          <div class="row" style="align-items:flex-end">
            <div class="kpi" id="kpiStreak">0 <small>days</small></div>
            <div class="spacer"></div>
            <div class="badge" id="badgeWeek">Week 1: Foundations</div>
          </div>
          <div class="progress-bar" style="margin-top:10px"><div id="streakBar" style="width:0%"></div></div>
          <div class="footer-note" style="margin-top:8px">Streak advances when you save both morning + evening entries.</div>
        </article>

        <article class="card" style="grid-column:span 6">
          <h2>Morning ‚Äî Premeditatio malorum</h2>
          <label class="muted" for="amInput">What challenges might arise? How will you meet them with virtue?</label>
          <textarea id="amInput" rows="5" placeholder="Examples: difficult meeting ‚Üí respond with patience and clarity; traffic ‚Üí practice acceptance; temptation ‚Üí choose discipline‚Ä¶"></textarea>
          <div class="row" style="margin-top:8px">
            <button class="primary" id="saveAM">Save morning entry</button>
            <span class="muted" id="amSaved" aria-live="polite"></span>
            <div class="spacer"></div>
            <button class="ghost" id="amBreathe">2‚Äëmin breathe</button>
          </div>
        </article>

        <article class="card" style="grid-column:span 6">
          <h2>Evening ‚Äî Reflection</h2>
          <div class="range">
            <label for="vWis">Wisdom</label>
            <input id="vWis" type="range" min="0" max="5" step="1">
            <output id="oWis">0</output>
          </div>
          <div class="range">
            <label for="vJust">Justice</label>
            <input id="vJust" type="range" min="0" max="5" step="1">
            <output id="oJust">0</output>
          </div>
          <div class="range">
            <label for="vCour">Courage</label>
            <input id="vCour" type="range" min="0" max="5" step="1">
            <output id="oCour">0</output>
          </div>
          <div class="range">
            <label for="vTemp">Temperance</label>
            <input id="vTemp" type="range" min="0" max="5" step="1">
            <output id="oTemp">0</output>
          </div>
          <label class="muted" for="pmInput" style="margin-top:8px;display:block">Notes</label>
          <textarea id="pmInput" rows="4" placeholder="Where did I live according to virtue? Where did I fall short? What did I learn?">
          </textarea>
          <div class="row" style="margin-top:8px">
            <button class="primary" id="savePM">Save evening entry</button>
            <span class="muted" id="pmSaved" aria-live="polite"></span>
          </div>
        </article>

        <article class="card" style="grid-column:span 12">
          <div class="row" style="justify-content:space-between"><h2 class="section-title">Dichotomy of Control</h2><span class="badge" id="countControl">0 in control</span></div>
          <p class="muted" style="margin-top:-4px">Sort concerns into what you can control (your judgments, choices, actions) vs what you must accept.</p>
          <div class="grid" style="gap:12px">
            <div class="card" style="grid-column:span 6;background:#0a1222">
              <h3 style="margin-top:0">Within My Control</h3>
              <div class="list" id="listControl"></div>
              <div class="row" style="margin-top:8px">
                <input id="inputControl" type="text" placeholder="e.g., my preparation for a talk">
                <button class="ghost" id="addControl">Add</button>
              </div>
            </div>
            <div class="card" style="grid-column:span 6;background:#0a1222">
              <h3 style="margin-top:0">Outside My Control</h3>
              <div class="list" id="listAccept"></div>
              <div class="row" style="margin-top:8px">
                <input id="inputAccept" type="text" placeholder="e.g., other people's opinions">
                <button class="ghost" id="addAccept">Add</button>
              </div>
            </div>
          </div>
        </article>
      </div>
    </section>

    <!-- EXERCISES TAB -->
    <section id="tab-exercises" class="hidden" role="tabpanel">
      <div class="grid">
        <article class="card" style="grid-column:span 6">
          <h2>Negative Visualization</h2>
          <p class="muted">Briefly imagine losing something you value‚Äîthen return to it with gratitude.</p>
          <textarea id="negViz" rows="5" placeholder="What would life be like without ‚Ä¶ (health, a friend, a privilege)?"></textarea>
          <div class="row" style="margin-top:8px">
            <button class="primary" id="saveNegViz">Save note</button>
            <span class="muted" id="negVizSaved"></span>
          </div>
        </article>
        <article class="card" style="grid-column:span 6">
          <h2>View from Above</h2>
          <p class="muted">Zoom out: you ‚Üí city ‚Üí planet ‚Üí stars. Reframe problems with cosmic perspective.</p>
          <button class="ghost" id="startView">3‚Äëstep guide</button>
          <details style="margin-top:8px">
            <summary class="muted">Show script</summary>
            <ol class="muted">
              <li>Picture yourself from the ceiling. Breathe slowly.</li>
              <li>Now from the sky: your city, tiny paths of life moving.</li>
              <li>Now from orbit among stars. Ask: which choices still matter? Choose virtue.</li>
            </ol>
          </details>
        </article>
        <article class="card" style="grid-column:span 12">
          <h2>Values ‚Üí Actions</h2>
          <div class="grid">
            <div class="card" style="grid-column:span 4;background:#0a1222">
              <h3>Wisdom</h3>
              <ul class="muted"><li>Pause before judging</li><li>Seek first to understand</li><li>Prefer truth over comfort</li></ul>
            </div>
            <div class="card" style="grid-column:span 4;background:#0a1222">
              <h3>Justice</h3>
              <ul class="muted"><li>Be fair & honest</li><li>Serve the common good</li><li>Keep your word</li></ul>
            </div>
            <div class="card" style="grid-column:span 4;background:#0a1222">
              <h3>Courage</h3>
              <ul class="muted"><li>Do the right thing afraid</li><li>Speak truth kindly</li><li>Endure discomfort</li></ul>
            </div>
          </div>
        </article>
      </div>
    </section>

    <!-- PROGRESS TAB -->
    <section id="tab-progress" class="hidden" role="tabpanel">
      <div class="grid">
        <article class="card" style="grid-column:span 5">
          <h2>Virtue Averages (7 days)</h2>
          <div class="list" id="virtueAverages"></div>
        </article>
        <article class="card" style="grid-column:span 7">
          <h2>Journal Heat (14 days)</h2>
          <div class="footer-note">Number of entries saved each day (0‚Äì2).</div>
          <div id="heat" style="display:grid;grid-template-columns:repeat(14,1fr);gap:6px;margin-top:10px"></div>
        </article>
        <article class="card" style="grid-column:span 12">
          <h2>Milestones</h2>
          <ul id="milestones" class="muted"></ul>
        </article>
      </div>
    </section>

    <!-- LIBRARY TAB -->
    <section id="tab-library" class="hidden" role="tabpanel">
      <article class="card">
        <h2>Lessons</h2>
        <p class="muted">Short, plain‚Äëlanguage lessons pairing a classic passage with a modern application.</p>
        <div id="lessonList" class="list"></div>
      </article>
    </section>

    <!-- SETTINGS TAB -->
    <section id="tab-settings" class="hidden" role="tabpanel">
      <div class="grid">
        <article class="card" style="grid-column:span 6">
          <h2>Path</h2>
          <div class="row" style="gap:8px">
            <select id="pathSelect" aria-label="Path select">
              <option>Calm</option><option>Resilience</option><option>Wisdom</option><option>Leadership</option><option>Discipline</option>
            </select>
            <button class="primary" id="savePath">Save</button>
          </div>
        </article>
        <article class="card" style="grid-column:span 6">
          <h2>Data</h2>
          <div class="row" style="gap:8px;flex-wrap:wrap">
            <button class="ghost" id="exportJSON">Export JSON</button>
            <button class="ghost" id="clearDay">Clear today</button>
            <button class="ghost" id="resetAll">Reset all</button>
          </div>
          <p class="footer-note">MVP stores data locally on your device. A future build can sync with Supabase.</p>
        </article>
      </div>
    </section>

  </main>

  <template id="lessonItem">
    <details class="card">
      <summary><strong class="title"></strong> <span class="badge tag"></span></summary>
      <blockquote class="quote" style="margin:8px 0 4px"></blockquote>
      <div class="muted source"></div>
      <p class="muted" style="margin-top:8px"></p>
    </details>
  </template>

  <script>
    // --- Simple Store (localStorage wrapper) ---
    const Store = {
      k:(...parts)=>['stoic',...parts].join('.'),
      get:(k, def=null)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):def }catch{ return def } },
      set:(k, v)=>localStorage.setItem(k, JSON.stringify(v)),
      del:(k)=>localStorage.removeItem(k),
    };

    const todayKey = () => new Date().toISOString().slice(0,10); // yyyy-mm-dd

    // --- Seed Content ---
    const QUOTES = [
      { text: "You have power over your mind‚Äînot outside events. Realize this, and you will find strength.", by:"Marcus Aurelius", tag:"Control", virtue:"Courage" },
      { text: "We suffer more often in imagination than in reality.", by:"Seneca", tag:"Perception", virtue:"Wisdom" },
      { text: "If it is not right, do not do it; if it is not true, do not say it.", by:"Marcus Aurelius", tag:"Integrity", virtue:"Justice" },
      { text: "Wealth consists not in having great possessions, but in having few wants.", by:"Epictetus", tag:"Desire", virtue:"Temperance" },
      { text: "No man is free who is not master of himself.", by:"Epictetus", tag:"Discipline", virtue:"Temperance" },
    ];

    const LESSONS = [
      { title: 'Dichotomy of Control', virtue:'Wisdom', source:'Epictetus ‚Äî Enchiridion 1',
        quote:'Some things are up to us and some are not.',
        body:'Make two lists for any worry: what you can choose (judgments, aims, actions) and what you cannot (past, weather, other people). Live where your choices matter.' },
      { title: 'Premeditatio Malorum', virtue:'Courage', source:'Seneca ‚Äî Letters',
        quote:'Rehearse in your mind adversity in advance so it cannot surprise you.',
        body:'Briefly visualize today\'s likely setbacks. Decide now how you will meet them with virtue so you are calm when they come.' },
      { title: 'View from Above', virtue:'Wisdom', source:'Marcus ‚Äî Meditations',
        quote:'Consider the world as a single living being, with one soul and one body.',
        body:'Zoom out to reset perspective. From above, most irritations shrink; duty and character remain.' },
      { title: 'Temper Desire', virtue:'Temperance', source:'Epictetus ‚Äî Discourses',
        quote:'Freedom is found in reducing desires, not in satisfying them.',
        body:'Prefer simple needs, clear aims, and disciplined routines. Measure success by fidelity to your values, not by outcomes.' },
    ];

    // --- UI Helpers ---
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    function toast(el, msg){ el.textContent = msg; el.style.opacity = 1; setTimeout(()=>{ el.style.opacity = .7 }, 1000); }

    // --- Tabs ---
    $$('nav[role="tablist"] .tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $$('nav .tab').forEach(b=>b.setAttribute('aria-selected','false'));
        btn.setAttribute('aria-selected','true');
        const target = btn.dataset.tab;
        $$('main > section[id^="tab-"]').forEach(sec=>sec.classList.add('hidden'));
        $('#tab-'+target).classList.remove('hidden');
      });
    });

    // --- Onboarding Path ---
    function loadPath(){
      const path = Store.get(Store.k('path'));
      if(!path){ $('#onboarding').style.display='block'; $('#pathPill').textContent = 'Choose a path'; }
      else { $('#onboarding').style.display='none'; $('#pathPill').textContent = 'Path: '+path; $('#pathSelect').value = path; }
    }
    $('#onboarding').addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-path]');
      if(!btn) return;
      Store.set(Store.k('path'), btn.dataset.path);
      loadPath();
    });
    $('#savePath').addEventListener('click', ()=>{ Store.set(Store.k('path'), $('#pathSelect').value); loadPath(); });

    // --- Quote of the day ---
    function seedOfDay(){
      const d = new Date(); return d.getFullYear()*1000 + (d.getMonth()+1)*50 + d.getDate();
    }
    function renderQuote(){
      const q = QUOTES[ seedOfDay() % QUOTES.length ];
      $('#quote').textContent = '‚Äú'+q.text+'‚Äù';
      $('#byline').textContent = '‚Äî '+q.by;
      $('#lessonTag').textContent = 'Virtue: '+q.virtue;
      $('#controlTag').textContent = 'Control: '+q.tag;
      $('#btnViewLesson').onclick = ()=>{
        // open the first matching lesson
        const idx = LESSONS.findIndex(l=>l.virtue===q.virtue || l.title.includes('Control'));
        if(idx>-1){
          $$('nav .tab').find(b=>b.dataset.tab==='library').click();
          const items = $$('#lessonList details');
          if(items[idx]) items[idx].open = true;
        }
      };
    }

    // --- Morning / Evening Journal ---
    function loadJournal(){
      const kAm = Store.k('journal', todayKey(), 'am');
      const kPm = Store.k('journal', todayKey(), 'pm');
      $('#amInput').value = Store.get(kAm, '')
      $('#pmInput').value = Store.get(kPm, '')
      const v = Store.get(Store.k('virtues', todayKey()), {Wis:0,Just:0,Cour:0,Temp:0});
      $('#vWis').value=v.Wis; $('#oWis').textContent=v.Wis;
      $('#vJust').value=v.Just; $('#oJust').textContent=v.Just;
      $('#vCour').value=v.Cour; $('#oCour').textContent=v.Cour;
      $('#vTemp').value=v.Temp; $('#oTemp').textContent=v.Temp;
    }
    $('#saveAM').addEventListener('click', ()=>{
      Store.set(Store.k('journal', todayKey(), 'am'), $('#amInput').value.trim());
      toast($('#amSaved'), 'Saved ‚úî');
      updateStreak(); drawHeat();
    });
    $('#savePM').addEventListener('click', ()=>{
      const virtues = {Wis:+$('#vWis').value, Just:+$('#vJust').value, Cour:+$('#vCour').value, Temp:+$('#vTemp').value};
      Store.set(Store.k('virtues', todayKey()), virtues);
      Store.set(Store.k('journal', todayKey(), 'pm'), $('#pmInput').value.trim());
      toast($('#pmSaved'), 'Saved ‚úî');
      updateStreak(); drawHeat(); calcVirtueAverages(); maybeMilestones();
    });
    $$('#vWis,#vJust,#vCour,#vTemp').forEach(el=>{
      el.addEventListener('input', ()=>{
        $('#oWis').textContent=$('#vWis').value;
        $('#oJust').textContent=$('#vJust').value;
        $('#oCour').textContent=$('#vCour').value;
        $('#oTemp').textContent=$('#vTemp').value;
      });
    });

    // --- Breathe (simple 2-min cycle: 4-4 box) ---
    $('#amBreathe').addEventListener('click', async ()=>{
      const btn = $('#amBreathe');
      btn.disabled = true; btn.textContent = 'Breathing‚Ä¶';
      const phase = async (label, ms)=>{ btn.textContent = label; await new Promise(r=>setTimeout(r,ms)); };
      for(let t=0;t<8;t++){ await phase('Inhale (4s)',4000); await phase('Hold (4s)',4000); await phase('Exhale (4s)',4000); await phase('Hold (4s)',4000); }
      btn.disabled=false; btn.textContent='2‚Äëmin breathe';
    });

    // --- Dichotomy of Control lists ---
    function renderConcerns(){
      const ctl = Store.get(Store.k('control', todayKey()), []);
      const acc = Store.get(Store.k('accept', todayKey()), []);
      const mk = (text, kind, i)=>{
        const el = document.createElement('div'); el.className='concern';
        el.innerHTML = `<span class="badge">${kind===1?'Control':'Accept'}</span><span class="text" style="flex:1">${text}</span>`+
          `<button class="ghost del" aria-label="Remove">‚úï</button>`;
        el.querySelector('.del').onclick = ()=>{
          const arr = kind===1?ctl:acc; arr.splice(i,1); Store.set(Store.k(kind===1?'control':'accept', todayKey()), arr); renderConcerns();
        };
        return el;
      };
      const lc = $('#listControl'); lc.innerHTML=''; ctl.forEach((t,i)=>lc.appendChild(mk(t,1,i)));
      const la = $('#listAccept'); la.innerHTML=''; acc.forEach((t,i)=>la.appendChild(mk(t,0,i)));
      $('#countControl').textContent = `${ctl.length} in control`;
    }
    $('#addControl').onclick = ()=>{ const v=$('#inputControl').value.trim(); if(!v) return; const arr=Store.get(Store.k('control', todayKey()), []); arr.push(v); Store.set(Store.k('control', todayKey()), arr); $('#inputControl').value=''; renderConcerns(); };
    $('#addAccept').onclick = ()=>{ const v=$('#inputAccept').value.trim(); if(!v) return; const arr=Store.get(Store.k('accept', todayKey()), []); arr.push(v); Store.set(Store.k('accept', todayKey()), arr); $('#inputAccept').value=''; renderConcerns(); };

    // --- Exercises tab ---
    $('#saveNegViz').onclick = ()=>{ Store.set(Store.k('exercise','negviz',todayKey()), $('#negViz').value.trim()); toast($('#negVizSaved'),'Saved ‚úî'); };
    $('#startView').onclick = ()=>{
      alert('3‚Äëstep View from Above:\n\n1) See yourself from the room\'s ceiling.\n2) Zoom out to your city.\n3) Zoom out to the stars.\nAsk: Which choices matter now? Choose virtue.');
    };

    // --- Library ---
    function renderLibrary(){
      const list = $('#lessonList'); list.innerHTML='';
      const tpl = $('#lessonItem').content;
      LESSONS.forEach(l=>{
        const n = tpl.cloneNode(true);
        n.querySelector('.title').textContent = l.title;
        n.querySelector('.tag').textContent = l.virtue;
        n.querySelector('.quote').textContent = '‚Äú'+l.quote+'‚Äù';
        n.querySelector('.source').textContent = l.source;
        n.querySelector('p').textContent = l.body;
        list.appendChild(n);
      });
    }

    // --- Progress ---
    function updateStreak(){
      const am = !!Store.get(Store.k('journal', todayKey(), 'am'));
      const pm = !!Store.get(Store.k('journal', todayKey(), 'pm'));
      const todayDone = am && pm;
      let streak = Store.get(Store.k('streak'), 0);
      let last = Store.get(Store.k('streakLast'));
      const today = todayKey();
      // If already counted today, keep. If new day and done, increment; if break, reset when next done
      if(last !== today){
        // new day; only increment when todayDone
        if(todayDone) { streak = (isYesterday(last)?streak+1:1); Store.set(Store.k('streakLast'), today); Store.set(Store.k('streak'), streak); }
      } else {
        // same day; if finished after saving second half ensure counted
        if(todayDone) { if(!streak) streak=1; Store.set(Store.k('streak'), streak); }
      }
      $('#kpiStreak').innerHTML = (Store.get(Store.k('streak'),0) || 0) + ' <small>days</small>';
      const s = Math.min(Store.get(Store.k('streak'),0), 21); // cap bar at 21 for UI
      $('#streakBar').style.width = (s/21*100).toFixed(0)+'%';
      // Week label
      const wk = Math.max(1, Math.ceil((Store.get(Store.k('streak'),0) || 1)/7));
      $('#badgeWeek').textContent = `Week ${wk}: ${['Foundations','Control','Courage','Justice','Temperance','Integration'][Math.min(wk-1,5)]}`;
    }
    function isYesterday(iso){
      if(!iso) return false; const d=new Date(iso); const y=new Date(); y.setDate(y.getDate()-1); return d.toISOString().slice(0,10)===y.toISOString().slice(0,10);
    }
    function drawHeat(){
      const box = $('#heat'); if(!box) return; box.innerHTML='';
      for(let i=13;i>=0;i--){
        const d = new Date(); d.setDate(d.getDate()-i); const k = d.toISOString().slice(0,10);
        const am = !!Store.get(Store.k('journal', k, 'am'));
        const pm = !!Store.get(Store.k('journal', k, 'pm'));
        const val = (am?1:0)+(pm?1:0);
        const cell = document.createElement('div');
        cell.title = `${k} ‚Äî ${val}/2 entries`;
        cell.style.height='18px'; cell.style.borderRadius='6px';
        cell.style.background = val===0? 'rgba(148,163,184,.15)': val===1? 'linear-gradient(90deg,#38bdf8, rgba(56,189,248,.3))' : 'linear-gradient(90deg,#38bdf8,#22c55e)';
        cell.style.border = '1px solid rgba(148,163,184,.2)';
        box.appendChild(cell);
      }
    }
    function calcVirtueAverages(){
      const sums = {Wis:0,Just:0,Cour:0,Temp:0, n:0};
      for(let i=0;i<7;i++){
        const d = new Date(); d.setDate(d.getDate()-i); const k = d.toISOString().slice(0,10);
        const v = Store.get(Store.k('virtues', k));
        if(v){ sums.Wis+=v.Wis; sums.Just+=v.Just; sums.Cour+=v.Cour; sums.Temp+=v.Temp; sums.n++; }
      }
      const list = $('#virtueAverages'); if(!list) return; list.innerHTML='';
      const mk = (label, val)=>{ const w=document.createElement('div'); w.innerHTML = `<div class="row"><strong>${label}</strong><div class="spacer"></div><span class="muted">${val.toFixed(1)}/5</span></div><div class="progress-bar" style="margin-top:6px"><div style="width:${(val/5*100).toFixed(0)}%"></div></div>`; return w; };
      if(sums.n){
        list.appendChild(mk('Wisdom', sums.Wis/sums.n));
        list.appendChild(mk('Justice', sums.Just/sums.n));
        list.appendChild(mk('Courage', sums.Cour/sums.n));
        list.appendChild(mk('Temperance', sums.Temp/sums.n));
      } else {
        list.innerHTML = '<div class="muted">No data yet ‚Äî save some evening entries.</div>';
      }
    }
    function maybeMilestones(){
      const ms = $('#milestones'); if(!ms) return; ms.innerHTML='';
      const streak = Store.get(Store.k('streak'),0);
      const badges = [];
      if(streak>=1) badges.push('‚Ä¢ First day of complete practice');
      if(streak>=7) badges.push('‚Ä¢ 7‚Äëday streak: Foundations complete');
      const neg = Store.get(Store.k('exercise','negviz', todayKey()));
      if(neg && neg.length>0) badges.push('‚Ä¢ Logged a Negative Visualization');
      const ctl = Store.get(Store.k('control', todayKey()), []);
      const acc = Store.get(Store.k('accept', todayKey()), []);
      if(ctl.length+acc.length>=5) badges.push('‚Ä¢ Sorted 5+ concerns via Dichotomy of Control');
      if(badges.length===0) ms.innerHTML = '<li>Practice to unlock milestones.</li>'; else ms.innerHTML = badges.map(b=>`<li>${b}</li>`).join('');
    }

    // --- Settings: Export / Reset ---
    $('#exportJSON').onclick = ()=>{
      const dump = {};
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i); if(!k.startsWith('stoic.')) continue; dump[k] = JSON.parse(localStorage.getItem(k));
      }
      const blob = new Blob([JSON.stringify(dump,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='stoic-journey-export.json'; a.click(); URL.revokeObjectURL(url);
    };
    $('#clearDay').onclick = ()=>{
      ['journal.am','journal.pm','virtues','control','accept'].forEach(s=>{
        localStorage.removeItem(Store.k(...s.split('.').length>1? s.split('.'):[s, todayKey()]));
      });
      loadJournal(); renderConcerns(); drawHeat(); calcVirtueAverages(); maybeMilestones(); updateStreak();
    };
    $('#resetAll').onclick = ()=>{
      if(confirm('Reset all Stoic Journey data on this device?')){
        const toDel = [];
        for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k.startsWith('stoic.')) toDel.push(k); }
        toDel.forEach(k=>localStorage.removeItem(k));
        loadPath(); renderQuote(); loadJournal(); renderConcerns(); drawHeat(); calcVirtueAverages(); maybeMilestones(); updateStreak(); renderLibrary();
      }
    };

    // --- Library list render on load ---
    renderLibrary();

    // --- Initial draw ---
    loadPath(); renderQuote(); loadJournal(); renderConcerns(); drawHeat(); calcVirtueAverages(); maybeMilestones(); updateStreak();
  </script>
</body>
</html>
